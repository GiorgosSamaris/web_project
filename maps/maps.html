<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- required -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin="anonymous"></script>

    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" /> -->
    <!-- <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script> -->

    <!-- leaflet-search -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.css" />
    <script src="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.js"></script>
    <script src="leaflet-search.js"></script>
    <!-- ------------------------------------------------ -->

    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="maps.css">
    <script src="stores.js"></script>
    <title>Maps</title>
</head>
<body>
    <div id="mapid"></div>
    <script>
        //#region initilization
        let testLat = 38.25673456255137;
        let testLon = 21.740706238205785;
        // 38.25673456255137, 21.740706238205785  test
        let userpos;
        let popupContent = "";
        let mymap = L.map('mapid');
        let results = [];
        let productsList = [];
        let resultsLayer = L.featureGroup();
        let tiles = L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mymap);
        //#endregion

        //#region Functions
        
        function popupContentStores(feature, isClose) {  
            popupContent = '<div class = "popup-container">';
                popupContent += "<b>";       //reset the content because its a global variable
                
                //show name and if not available then the brand name in english
                if (feature.properties.name) {
                    popupContent += feature.properties.name;
                } else if (feature.properties['brand:en']) {
                    popupContent += feature.properties['brand:en'];
                }
            
                // Add coordinates 
                    // popupContent += "<br>Coordinates: " + feature.geometry.coordinates[1] + ", " + feature.geometry.coordinates[0];

                //Add opening hours if available
                if (feature.properties.opening_hours) {
                    popupContent += "<br>Opening hours: " + feature.properties.opening_hours;
                }  
                let productsContent = "<ol>";
                productsList.forEach((product) => {
                    if(feature.properties.name === 'Kiosk'){
                        if(product.subcategory === "991276688c8c4a91b5524b1115122ec1"){
                            // console.log(product.name);
                            productsContent += "<li>" + product.name + "</li>";
                        }
                    }

                });
                productsContent += "</ol>"; 
                popupContent += "<br>" + "Products on sale:" + productsContent;
                if(isClose === true){
                    popupContent += '<div class = "button-container">';
                    popupContent += '<button type = "submit" class = "submit-offer" > Add Offer </button>';
                    popupContent += '<button type = "submit" class = "submit-offer" > Review </button>'
                    popupContent += '</div>';
                } 
                popupContent += "</b>";
            popupContent += '</div>'
            return popupContent;
        }

        function userStoreDistance(lat1, lon1 , lat2, lon2) {
            //using the haversine Formula
            const R = 6371.0; //Earth's radius in km

            //convert lat and lon to radians
            const lat1Rad = (Math.PI / 180) * lat1;
            const lon1Rad = (Math.PI / 180) * lon1; 
            const lat2Rad = (Math.PI / 180) * lat2;
            const lon2Rad = (Math.PI / 180) * lon2; 

            //calculate difference
            const latDifference = lat2Rad - lat1Rad;
            const lonDifference = lon2Rad - lon1Rad;

            //formula
            const a = Math.sin(latDifference / 2) * Math.sin(latDifference / 2) +
                      Math.cos(lat1Rad) * Math.cos(lat2Rad) * 
                      Math.sin(lonDifference / 2) * Math.sin(lonDifference / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            const distanceInMeters = distance * 1000;
            const roundedDistance = distance.toFixed(2);

            return [roundedDistance, distanceInMeters];
        }

        async function fetchProducts() {    //fetch api to pull data from JSON file
            try {
                const response = await fetch("products_and_categories.json");
                const data = await response.json();
                data.products.forEach((product) => {
                    //creates a variable that consists of four attributes that describe a product 
                    const { id, name, category, subcategory } = product;    
                    //adds each product to the list
                    productsList.push(product);
                });
            } catch (error) {
                console.error("Error loading the JSON data:", error);
            }
        }

        async function initializeMap() {
            mymap.setView([testLat,testLon], 17);
            var markersLayer = new L.LayerGroup();
            mymap.addLayer(markersLayer);
            userpos = new L.marker([testLat,testLon]).addTo(mymap); 
            userpos.bindPopup("You're here!").openPopup();
   
            await fetchProducts();

            L.geoJson(stores_json, {    //pulls data from GeoJSON file
                onEachFeature: function(feature, layer) {
                    let isClose = false;
                    var currStoreDist = userStoreDistance(testLat, testLon, layer.feature.geometry.coordinates[1], layer.feature.geometry.coordinates[0]);
                    if(layer.feature.properties['addr:street']){
                        //combines two features into one for use in search if the second attribute exists
                        layer.feature.properties.searchProp = layer.feature.properties.name + ', ' + layer.feature.properties['addr:street'];
                        //layer here refers to the layer that contains the JSON items and feature refers to the JSON object being used
                    } else {
                        layer.feature.properties.searchProp = layer.feature.properties.name + ', ' + currStoreDist[0] + ' Km';
                    }


                    if(currStoreDist[1] <= 70){
                        console.log(currStoreDist*1000);
                        isClose = true;
                        layer.bindPopup(popupContentStores(feature,isClose));

                    } else {
                        isClose = false;
                        //binds the popup content to every marker
                        layer.bindPopup(popupContentStores(feature,isClose));
                    }
                    

                }
            }).addTo(markersLayer);     //adds the stores in the markersLayer

            function groupFindings(text, data) {    //text is the user input and data is the marker
                //ensures that the item has the name property before the process of matching with the input begins
                if (data.properties && data.properties.name) {   
                    //checks if the name property(lowerCase) of the item matches the input(lowerCase)
                    return data.properties.name.toLowerCase().includes(text.toLowerCase());
                }
                return false;   //return false if name doesnt exist
            }

            var searchResultsLayer = new L.LayerGroup();

            var searchBar = new L.Control.Search({
                position: 'topleft',
                layer: markersLayer,
                propertyName: 'searchProp', 
                zoom: 16,
                initial: false,
                exactMatch: false,
                buildTip: function(text, val) {
                    // var type = val.layer.feature.properties.shop;
                    // console.log(val);
                    // var filteredLayer = new L.LayerGroup();
                    // var redIcon = L.icon({
                    //     iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    //     iconSize: [25, 41],
                    //     iconAnchor: [12, 41],
                    //     popupAnchor: [1, -34],
                    // });
                    // for (var i = 0; i < val.length; i++) {
                    //     var resultMarker = val[i].layer; // Get the original marker from markersLayer
                    //     console.log(resultMarker.feature);
                    //     if(val[i].layer.feature.properties.name.toLowerCase() === text.toLowerCase()){
                    //         resultMarker.setIcon(redIcon); // Set the red icon directly on the original marker
                    //         resultMarker.addTo(filteredLayer);
                    //     }
                    // }
                    // console.log(filteredLayer);
                    // markersLayer.clearLayers();
                    // markersLayer.addLayer(filteredLayer);
                    //return the names of the stores and their type
                    return '<a href="#" class="tip-results">'+text + '</a>' + '&nbsp' +  '<br>';
                }
            }).addTo(mymap);

            
        }

        
        //#endregion
        
        //get users location
        // if("geolocation" in navigator) {
        //     //add prompt for user's location
        //     navigator.geolocation.getCurrentPosition(  //get current position of user
        //         (position) => {
        //             lat = position.coords.latitude;
        //             lng = position.coords.longitude;
        //             initializeMap();
        //         },
        //         (error) => {
        //             console.error("Error getting user location: ", error);
        //         }
        //         );
        //     } else {
        //         console.error("Geolocation is not supported by this browser");
        //         initializeMap();
        //     }
            
        // let empty = [];
        mymap.setView([38.2462420, 21.7350847], 16);
        initializeMap();
            // if (results.)
            //     results = empty;
        
        
        
        </script>
</body>
</html>
