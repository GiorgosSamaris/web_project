<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- required -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin="anonymous"></script>

    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" /> -->
    <!-- <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script> -->

    <!-- leaflet-search -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.css" />
    <script src="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.js"></script>
    <script src="leaflet-search.js"></script>
    <!-- ------------------------------------------------ -->

    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="maps.css">
    <script src="stores.js"></script>
    <title>Maps</title>
</head>
<body>
    <div id="mapid"></div>
    <script>
        //#region initilization
        let lat = 38.2462420;
        let lng = 21.7350847;
        let userpos;
        let popupContent = "";
        let mymap = L.map('mapid');
        var resultsLayer = L.featureGroup();
        let results = [];
        var productsList = [];
        let tiles = L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mymap);
        //#endregion

        //#region Functions
        function markerClick(event) {
            this.getPopup()
                .setLatLng(event.latlng)
                .setContent("Συντεταγμένες σημείου: " + event.latlng.toString());
        }
        
        function popupContentStores(feature) {  
            popupContent = "<b>";       //reset the content because its a global variable
            console.log(popupContent);
            //show name and if not available then the brand name in english
            if (feature.properties.name) {
                popupContent += feature.properties.name;
            } else if (feature.properties['brand:en']) {
                popupContent += feature.properties['brand:en'];
            }
        
            // Add coordinates 
                // popupContent += "<br>Coordinates: " + feature.geometry.coordinates[1] + ", " + feature.geometry.coordinates[0];
            
            //Add opening hours if available
            if (feature.properties.opening_hours) {
                popupContent += "<br>Opening hours: " + feature.properties.opening_hours;
            }  
            let productsContent = "<ul>";
            productsList.forEach((product) => {
                if(product.subcategory === "991276688c8c4a91b5524b1115122ec1"){
                    // console.log(product.name);
                    productsContent += "<li>" + product.name + "</li>";
                }
            });
            productsContent += "</ul>"; 
            popupContent += "<br>" + "Products on sale:" + productsContent;
            
            // popupContent = "<b>" + popupContent + "</b>";
            popupContent += "</b>";
            return popupContent;
        }

        async function fetchProducts() {    //fetch is an asynchronous function
            try {
                const response = await fetch("products_and_categories.json");
                const data = await response.json();
                data.products.forEach((product) => {
                    const { id, name, category, subcategory } = product;
                    productsList.push(product);
                });
            } catch (error) {
                console.error("Error loading the JSON data:", error);
            }
        }

        async function initializeMap() {
            mymap.setView([lat,lng], 16);
            var markersLayer = new L.LayerGroup();
            mymap.addLayer(markersLayer);
            userpos = new L.marker([lat,lng]).addTo(mymap); 
            userpos.bindPopup("You're here!").openPopup();


            //  fetch("products_and_categories.json")
            // .then((res) => res.json())
            // .then((data) => {
            //     // console.log(data.products[0].subcategory);
            //     data.products.forEach(product => {
            //         const {id, name, category, subcategory} = product;
            //         productsList.push(product);
                    
            //         // console.log(product);
            //         // console.log(productsList.length);
            //     });
            //     // popupContentProducts();
                
            // })
            // .catch(error => {
            //     console.error('Error loading the JSON data:', error);
            // });
            
            await fetchProducts();

            L.geoJson(stores_json, {
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(popupContentStores(feature));
                }
            }).addTo(markersLayer);

            function groupFindings(text, data) {
                if (data.properties && data.properties.name) {
                    return data.properties.name.toLowerCase().includes(text.toLowerCase());
                }
                return false;
            }


            var searchBar = new L.Control.Search({
                position: 'topright',
                layer: markersLayer,
                propertyName: ['name', 'brand:en'],
                zoom: 16,
                initial: false,
                exactMatch: false,
                buildTip: function(text, val) {
                    var type = val.layer.feature.properties.shop;
                    return '<a href="#" class="'+type+'">'+text+'<b>'+type+'</b></a>';
                }
            }).addTo(mymap);
            
            
            
            const container = searchBar.getContainer();

            const inputElement = container.querySelector('input[type="text"]');

            inputElement.addEventListener("keypress", function (e) {
                if(e.key === "Enter" && results.length) {
                    console.log(results);
                    markersLayer.remove();
                    results.forEach((result) => {
                        const marker = L.marker(result);
                        resultsLayer.addLayer(marker);
                    });
                    mymap.fitBounds(resultsLayer.getBounds());
                } else if (e.key === "Enter") {
                    alert("Error no results were found!");

                }
            });
            // window.onload = function () {
            // initializeMap();
        // };
            
        }
        //#endregion
        
        //get users location
        // if("geolocation" in navigator) {
        //     //add prompt for user's location
        //     navigator.geolocation.getCurrentPosition(  //get current position of user
        //         (position) => {
        //             lat = position.coords.latitude;
        //             lng = position.coords.longitude;
        //             initializeMap();
        //         },
        //         (error) => {
        //             console.error("Error getting user location: ", error);
        //         }
        //         );
        //     } else {
        //         console.error("Geolocation is not supported by this browser");
        //         initializeMap();
        //     }
            
        // let empty = [];
        mymap.setView([38.2462420, 21.7350847], 16);
        initializeMap();
            // if (results.)
            //     results = empty;
        
        
        
        </script>
</body>
</html>
