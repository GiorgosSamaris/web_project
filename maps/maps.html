<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- required -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin="anonymous"></script>
    
    <!-- leaflet-search -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.css" />
    <script src="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.js"></script>
    <script src="leaflet-search.js"></script>
    <!-- ------------------------------------------------ -->

    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="maps.css">
    <script src="json/stores.js"></script>
    <title>Maps</title>
</head>
<body>
    <div id="mapid"></div>
    <script>
        //#region initilization
        let testLat = 38.25673456255137;
        let testLon = 21.740706238205785;
        // 38.25673456255137, 21.740706238205785  test
        let index = 1;
        let userpos;
        let popupContent = "";
        let mymap = L.map('mapid');

        let storesList = [];
        let productsList = [];
        let categoriesList = [];
        let subCategoriesList = [];
        let offersList = []; 

        //#region Icons

        var redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]}); 

        var greenIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]});
        
        var blueIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]});
        
        var orangeIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]});
        
        var yellowIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]});
        
        var violetIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]});

        var greyIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-grey.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]});

        var blackIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-black.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]});
        
        var goldIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]});

        //#endregion

        const storeIcons = {
            "Σκλαβενίτης": redIcon,
            "Ανδρικόπουλος": greenIcon,
            "ΑΝΔΡΙΚΟΠΟΥΛΟΣ": greenIcon,
            "Lidl": violetIcon,
            "Μασούτης": orangeIcon,
            "AB ": yellowIcon,
            "Βασιλόπουλος": yellowIcon,
            "ΒΑΣΙΛΟΠΟΥΛΟΣ": yellowIcon,
            "Kiosk": blackIcon,
            "Mini Market": goldIcon,
            "ΚΡΟΝΟΣ": greyIcon,
        };

        var markersLayer = new L.LayerGroup();  
        let tiles = L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mymap);
        //#endregion

        //#region Functions

        function popupContentStores(feature,isClose, offersList) {  
            popupContent = '<div class = "popup-container">';
                popupContent += "<b>";       //reset the content because its a global variable
                // console.log(feature.properties.store_name);
                //show name
                // console.log(feature.properties.store_name);
                if (feature.properties.store_name) {
                    // console.log(store_name);
                    popupContent += feature.properties.store_name + "<br>";
                } 
                popupContent += "Current offers: " + "<br>";
                popupContent += '<div class = "offers-container">';
                popupContent += "<ol>"
                offersList.forEach((offer) => {
                    popupContent += "<li>" + 
                                    offer.name + " " +
                                    "price: " + offer.offer_price + "&euro;" + "<br>" +
                                    '<div class = date-likes-dislikes>' +
                                    offer.creation_date + " " +
                                    offer.number_of_likes + " " +
                                    offer.number_of_dislikes +
                                    '</div>' +
                                    offer.in_stock +
                                    "</li>"; 
                });
                popupContent += "</ol>" + "</div>"; 
                popupContent += "<br>" 
                if(isClose === true){
                    popupContent += '<div class = "button-container">';
                    popupContent += '<button type = "submit" class = "submit-offer" > Add Offer </button>';
                    popupContent += '<button type = "submit" class = "submit-offer" > Review </button>'
                    popupContent += '</div>';
                } 
                popupContent += "</b>";
            popupContent += '</div>'
            return popupContent;
        }
 
        function userStoreDistance(lat1, lon1 , lat2, lon2) {
            //using the haversine Formula
            const R = 6371.0; //Earth's radius in km

            //convert lat and lon to radians
            const lat1Rad = (Math.PI / 180) * lat1;
            const lon1Rad = (Math.PI / 180) * lon1; 
            const lat2Rad = (Math.PI / 180) * lat2;
            const lon2Rad = (Math.PI / 180) * lon2; 

            //calculate difference
            const latDifference = lat2Rad - lat1Rad;
            const lonDifference = lon2Rad - lon1Rad;

            //formula
            const a = Math.sin(latDifference / 2) * Math.sin(latDifference / 2) +
                      Math.cos(lat1Rad) * Math.cos(lat2Rad) * 
                      Math.sin(lonDifference / 2) * Math.sin(lonDifference / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            const distanceInMeters = distance * 1000;
            const roundedDistance = distance.toFixed(2);

            return [roundedDistance, distanceInMeters];
        }

        // async function fetchStores() {
        //     try{
        //         const response = await fetch('json/stores.json');
        //         const textData = await response.text();
        //         const cleanedData = textData.trim();
        //         const data =  JSON.parse(cleanedData);
        //         data.forEach((store) => {
        //             const {store_id, store_name, longitude, latitude, map_id} = store;
        //             // console.log(store);
        //             storesList.push(store);
        //         });
        //     } catch (error) {
        //         console.error("Error loading the json data: ", error);
        //     }
            
        // }

        async function fetchProducts() {    //fetch api to pull data from JSON file
            try {
                const response = await fetch("products_and_categories.json");
                const data = await response.json();
                data.products.forEach((product) => {
                    //creates a variable that consists of four attributes that describe a product 
                    const { productId, productName, productCategory, productSubcategory } = product;  
                    //adds each product to the list
                    productsList.push(product);
                });
                //onEach and onEachFeature are specific to leaflet
                data.categories.forEach((category) => {
                    const {categoryId, categoryName, subcategories} = category;  
                    category.subcategories.forEach((subCategory) => {
                        const {subCatName, subCatUuid} = subCategory;
                        subCategoriesList.push(subCategory);
                    })
                    categoriesList.push(category);
                });
                // console.log(subCategoriesList);
                // data.categories.subcategories.forEach((subcategory) => {
                //     const {subCatName, sunCatUuid} = subcategory;
                //     subcategoriesList.push(subcategory);
                // });
            } catch (error) {
                console.error("Error loading the JSON data:", error);
            }
        }

        async function fetchOffers(storeName){
            try {
                const response = await fetch("json/offers.json");
                const data = await response.json();
                offersList = [];//empty the list for the offers of the next store
                data.forEach((offer) => {
                    if(offer.store_name === storeName){
                        console.log(offer.store_name);
                        console.log(storeName);
                        const {username, 
                            offer_id, 
                            creation_date, 
                            expiration_date, 
                            number_of_likes, 
                            number_of_dislikes, 
                            offer_price,
                            in_stock,
                            name } = offer;

                        offersList.push(offer);
                    }
                });
                console.log(offersList);
                return offersList;
            } catch (error) {
                console.error("Error loading the json data");
            }
        }

        function containsWord(inputString, targetWord) {
            const lowercaseInput = inputString.toLowerCase(); // Convert input string to lowercase
            const lowercaseTarget = targetWord.toLowerCase(); // Convert target word to lowercase

            const words = lowercaseInput.split(/\s+/); // Split the lowercase input string into an array of words
            return words.includes(lowercaseTarget); // Check if the array of words includes the lowercase target word
        }

        async function initializeMap() {
            mymap.setView([testLat,testLon], 17);
            userpos = new L.marker([testLat,testLon]).addTo(mymap); 
            userpos.bindPopup("You're here!").openPopup();
            let isClose = false;

            // await fetchStores();
            // console.log(storesList);
            // storesList.forEach((store) => {
            //     // console.log(store);
            //     // console.log(store.latitude);
            //     let marker = new L.marker([store.latitude, store.longitude]).addTo(mymap);

            //     var currStoreDist = userStoreDistance(testLat, testLon, store.latitude, store.longitude);

            //     if(currStoreDist[1] <= 50){
            //         isClose = true;
            //         marker.bindPopup(popupContentStores(store,isClose));
            //     } else {
            //         isClose = false;
            //         marker.bindPopup(popupContentStores(store,isClose));
            //     }
            // });
            // await fetchProducts();
            L.geoJson(stores_json, {    //pulls data from GeoJSON file
                onEachFeature: function(feature, layer) {
                    const storeName = layer.feature.properties.store_name;
                    const storeLat = layer.feature.properties.latitude;
                    const storeLon = layer.feature.properties.longitude;
                    const address = layer.feature.properties.address;
                    var searchProp = layer.feature.properties.searchProp;
                    var isClose = layer.feature.properties.isClose;

                    var currStoreDist = userStoreDistance(testLat, testLon, storeLat, storeLon);

                    if (storeIcons.hasOwnProperty(storeName)) {// checks if the store name is in the storeIcons object
                        layer.setIcon(storeIcons[storeName]);   //assigns the appropriate icon to the marker
                    } 
                        
                    if(address != "Unknown"){
                    //combines two features into one for use in search if the second attribute exists
                        searchProp = storeName + ', ' + address;
                    //layer here refers to the layer that contains the JSON items and feature refers to the JSON object being used
                    } else {
                        searchProp = storeName + ', ' + currStoreDist[0] + ' Km';
                    }
                    if(currStoreDist[1] <= 70){ //check for stores that are nearby the users location
                        //enable the buttons for adding offer and reviewing
                        isClose = true;
                        layer.on('click', async function(){
                            layer.bindPopup(popupContentStores(feature,true,await fetchOffers(storeName)));
                        })
                    } else {
                        isClose = false;
                        //binds the popup content to every marker
                        layer.on('click', async function(){
                            layer.bindPopup(popupContentStores(feature,false,await fetchOffers(storeName)));
                        })
                    }
                     
                    
                    


                }
            }).addTo(markersLayer);     //adds the stores in the markersLayer  
                    
            var searchBar = new L.Control.Search({
                position: 'topleft',
                layer: markersLayer,
                propertyName: 'searchProp', 
                zoom: 16,
                initial: false,  //initially hides the search bar,
                exactMatch: false,
                tipAutoSubmit: false,
                marker: {
                    icon: redIcon,
                },
                buildTip: function(text, val) {
                    // var marker = layer;
                    // console.log(val.layer._icon.style);
                    // val.layer._icon.style.[background-color] = 'green';
                    // val.layer._icon = redIcon;
                    // markersLayer.getLayer(val.layer._leaflet_id).setIcon(redIcon);
                    // layer.setIcon(redIcon);
                    // markersLayer.eachLayer(function(layer){
                    //     if(layer.feature.properties.latitude === val.lat && layer.feature.properties.longitude === val.lng){
                    //         layer.setIcon(redIcon);
                    //     }
                    // });
                    // var marker = new L.marker([val.lat, val.lng], {icon: redIcon});
                    // markersLayer.addLayer(marker);
                    //return the names of the stores and their type
                    return '<a href="#" class="tip-results">'+text + '</a>' + '&nbsp' +  '<br>';
                }
            }).addTo(mymap);
        }

        
        //#endregion
        
        //get users location
        // if("geolocation" in navigator) {
        //     //add prompt for user's location
        //     navigator.geolocation.getCurrentPosition(  //get current position of user
        //         (position) => {
        //             lat = position.coords.latitude;
        //             lng = position.coords.longitude;
        //             initializeMap();
        //         },
        //         (error) => {
        //             console.error("Error getting user location: ", error);
        //         }
        //         );
        //     } else {
        //         console.error("Geolocation is not supported by this browser");
        //         initializeMap();
        //     }
            
        // let empty = [];
        mymap.setView([38.2462420, 21.7350847], 16);
        initializeMap();
            // if (results.)
            //     results = empty;
        
        
        
        </script>
</body>
</html>