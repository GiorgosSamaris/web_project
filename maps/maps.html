<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- required -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin="anonymous"></script>

    <!-- <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" /> -->
    <!-- <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script> -->

    <!-- leaflet-search -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.css" />
    <script src="https://unpkg.com/leaflet-search@2.9.9/dist/leaflet-search.min.js"></script>
    <script src="leaflet-search.js"></script>
    <!-- ------------------------------------------------ -->

    <link rel="shortcut icon" href="#">
    <link rel="stylesheet" href="maps.css">
    <script src="json/stores.js"></script>
    <title>Maps</title>
</head>
<body>
    <div id="mapid"></div>
    <script>
        //#region initilization
        let testLat = 38.25673456255137;
        let testLon = 21.740706238205785;
        // 38.25673456255137, 21.740706238205785  test
        let index = 1;
        let userpos;
        let popupContent = "";
        let mymap = L.map('mapid');
        let storesList = [];
        let productsList = [];
        let categoriesList = [];
        let subCategoriesList = [];
        let offersList = []; 
        let resultsLayer = L.featureGroup();
        let tiles = L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(mymap);
        //#endregion

        //#region Functions
        
        function getSubCategoryName(subCategoryId) {
            // console.log(subCategoryId);
            for(const subCategory of subCategoriesList){
                if(subCategory.uuid === subCategoryId)
                    return subCategory.name;
            }
            return null;
        }

        function popupContentStores(feature,isClose, displayOffers) {  
            popupContent = '<div class = "popup-container">';
                popupContent += "<b>";       //reset the content because its a global variable
                // console.log(feature.properties.store_name);
                //show name 
                if (feature.properties.store_name) {
                    // console.log(store_name);
                    popupContent += feature.properties.store_name + "<br>";
                } 
                if(displayOffers === true){
                    offersList.forEach((offer) => {
                        popupContent += "<li>" + '<div class = "offers-container">' + 
                                        offer.name + 
                                        offer.offer_price + 
                                        '<div class = date-likes-dislikes>' +
                                        offer.creation_date + 
                                        offer.number_of_likes +
                                        offer.number_of_dislikes +
                                        '</div>' +
                                        offer.in_stock +
                                        "</div>"+
                                        "</li>"; 
                    });
                }
                // Add coordinates 
                    // popupContent += "<br>Coordinates: " + feature.geometry.coordinates[1] + ", " + feature.geometry.coordinates[0];

                //Add opening hours if available
                // if (feature.properties.opening_hours) {
                //     popupContent += "<br>Opening hours: " + feature.properties.opening_hours;
                // }  
                // let productsContent = "<ol>";
                // productsList.forEach((product) => {
                //     if(feature.properties.name === 'Kiosk'){
                //         if(product.subcategory === "991276688c8c4a91b5524b1115122ec1"){
                //             // console.log(product.name);
                //             productsContent += "<li>" + product.name + "&nbsp" + '(' + getSubCategoryName("991276688c8c4a91b5524b1115122ec1") + ')' + "</li>";
                //         }
                //     }
                // });

                // productsContent += "</ol>"; 
                // popupContent += "<br>" + "Products on sale:" + productsContent;
                if(isClose === true){
                    popupContent += '<div class = "button-container">';
                    popupContent += '<button type = "submit" class = "submit-offer" > Add Offer </button>';
                    popupContent += '<button type = "submit" class = "submit-offer" > Review </button>'
                    popupContent += '</div>';
                } 
                popupContent += "</b>";
            popupContent += '</div>'
            return popupContent;
        }
 
        function userStoreDistance(lat1, lon1 , lat2, lon2) {
            //using the haversine Formula
            const R = 6371.0; //Earth's radius in km

            //convert lat and lon to radians
            const lat1Rad = (Math.PI / 180) * lat1;
            const lon1Rad = (Math.PI / 180) * lon1; 
            const lat2Rad = (Math.PI / 180) * lat2;
            const lon2Rad = (Math.PI / 180) * lon2; 

            //calculate difference
            const latDifference = lat2Rad - lat1Rad;
            const lonDifference = lon2Rad - lon1Rad;

            //formula
            const a = Math.sin(latDifference / 2) * Math.sin(latDifference / 2) +
                      Math.cos(lat1Rad) * Math.cos(lat2Rad) * 
                      Math.sin(lonDifference / 2) * Math.sin(lonDifference / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            const distanceInMeters = distance * 1000;
            const roundedDistance = distance.toFixed(2);

            return [roundedDistance, distanceInMeters];
        }

        // async function fetchStores() {
        //     try{
        //         const response = await fetch('json/stores.json');
        //         const textData = await response.text();
        //         const cleanedData = textData.trim();
        //         const data =  JSON.parse(cleanedData);
        //         data.forEach((store) => {
        //             const {store_id, store_name, longitude, latitude, map_id} = store;
        //             // console.log(store);
        //             storesList.push(store);
        //         });
        //     } catch (error) {
        //         console.error("Error loading the json data: ", error);
        //     }
            
        // }

        async function fetchProducts() {    //fetch api to pull data from JSON file
            try {
                const response = await fetch("products_and_categories.json");
                const data = await response.json();
                data.products.forEach((product) => {
                    //creates a variable that consists of four attributes that describe a product 
                    const { productId, productName, productCategory, productSubcategory } = product;  
                    //adds each product to the list
                    productsList.push(product);
                });
                //onEach and onEachFeature are specific to leaflet
                data.categories.forEach((category) => {
                    const {categoryId, categoryName, subcategories} = category;  
                    category.subcategories.forEach((subCategory) => {
                        const {subCatName, subCatUuid} = subCategory;
                        subCategoriesList.push(subCategory);
                    })
                    categoriesList.push(category);
                });
                // console.log(subCategoriesList);
                // data.categories.subcategories.forEach((subcategory) => {
                //     const {subCatName, sunCatUuid} = subcategory;
                //     subcategoriesList.push(subcategory);
                // });
            } catch (error) {
                console.error("Error loading the JSON data:", error);
            }
        }

        async function fetchOffers(storeName){
            try {
                const response = await fetch("json/offers.json");
                const data = await response.json();
                index++;
                data.forEach((offer) => {
                    if(offer.store_name === storeName){
                        const {username, 
                            offer_id, 
                            creation_date, 
                            expiration_date, 
                            number_of_likes, 
                            number_of_dislikes, 
                            offer_price,
                            in_stock,
                            name } = offer;

                    }
                    offersList.push(offer);
                });
                console.log(offersList);
            } catch (error) {
                console.error("Error loading the json data");
            }
        }

        async function initializeMap() {
            mymap.setView([testLat,testLon], 17);
            var markersLayer = new L.LayerGroup();
            userpos = new L.marker([testLat,testLon]).addTo(mymap); 
            userpos.bindPopup("You're here!").openPopup();
            let isClose = false;

            // await fetchStores();
            // console.log(storesList);
            // storesList.forEach((store) => {
            //     // console.log(store);
            //     // console.log(store.latitude);
            //     let marker = new L.marker([store.latitude, store.longitude]).addTo(mymap);

            //     var currStoreDist = userStoreDistance(testLat, testLon, store.latitude, store.longitude);

            //     if(currStoreDist[1] <= 50){
            //         isClose = true;
            //         marker.bindPopup(popupContentStores(store,isClose));
            //     } else {
            //         isClose = false;
            //         marker.bindPopup(popupContentStores(store,isClose));
            //     }
            // });
            // await fetchProducts();
            L.geoJson(stores_json, {    //pulls data from GeoJSON file
                onEachFeature: function(feature, layer) {
                    var currStoreDist = userStoreDistance(
                    testLat, 
                    testLon, 
                    layer.feature.geometry.coordinates[1], 
                    layer.feature.geometry.coordinates[0]);
                    if(layer.feature.properties.address != "Unknown"){
                        //combines two features into one for use in search if the second attribute exists
                        layer.feature.properties.searchProp = layer.feature.properties.store_name + ', ' + 
                        layer.feature.properties.address;
                        //layer here refers to the layer that contains the JSON items and feature refers to the JSON object being used
                    } else {
                        layer.feature.properties.searchProp = layer.feature.properties.store_name + ', ' + 
                        currStoreDist[0] + ' Km';
                    }
                    
                    if(currStoreDist[1] <= 70){ //check for stores that are nearby the users location
                        // console.log(currStoreDist*1000);
                        //enable the buttons for adding offer and reviewing
                        layer.feature.properties.isClose = true;
                        layer.bindPopup(popupContentStores(feature,true,false));
                        
                    } else {
                        layer.feature.properties.isClose = false;
                        //binds the popup content to every marker
                        layer.bindPopup(popupContentStores(feature,false,false));
                    }
                }
            }).addTo(markersLayer);     //adds the stores in the markersLayer
            
            mymap.addLayer(markersLayer);
            

            function groupFindings(text, data) {    //text is the user input and data is the marker
                //ensures that the item has the name property before the process of matching with the input begins
                if (data.properties && data.properties.name) {   
                    //checks if the name property(lowerCase) of the item matches the input(lowerCase)
                    return data.properties.name.toLowerCase().includes(text.toLowerCase());
                }
                return false;   //return false if name doesnt exist
            }

            // var searchResultsLayer = new L.LayerGroup();
            var searchBar = new L.Control.Search({
                position: 'topleft',
                layer: markersLayer,
                propertyName: 'searchProp', 
                zoom: 16,
                initial: false,
                exactMatch: true,
                buildTip: function(text, val) {
                    // var redIcon = L.icon({
                    //     iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    //     iconSize: [25, 41],
                    //     iconAnchor: [12, 41],
                    //     popupAnchor: [1, -34],
                    // });
                    // var marker = layer;
                    // console.log(val);
                    for(var i = 0; i < val.length   ; i++){
                        console.log(val[i].label);
                    }
                    // val.setIcon( new L.icon({
                    //     iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                    //     iconSize: [25, 41],
                    //     iconAnchor: [12, 41],
                    //     popupAnchor: [1, -34],
                    // })); // Set your custom icon here
                    //return the names of the stores and their type
                    return '<a href="#" class="tip-results">'+text + '</a>' + '&nbsp' +  '<br>';
                }
            }).addTo(mymap);

            // searchBar.on("search:locationfound", async function(layer){
            //     await fetchOffers(layer.feature.properties.store_name);
            //     let isClose = layer.feature.properties.isClose;
            //     layer.bindPopup(popupContent(feature,isClose,true));
            // });

            
        }

        
        //#endregion
        
        //get users location
        // if("geolocation" in navigator) {
        //     //add prompt for user's location
        //     navigator.geolocation.getCurrentPosition(  //get current position of user
        //         (position) => {
        //             lat = position.coords.latitude;
        //             lng = position.coords.longitude;
        //             initializeMap();
        //         },
        //         (error) => {
        //             console.error("Error getting user location: ", error);
        //         }
        //         );
        //     } else {
        //         console.error("Geolocation is not supported by this browser");
        //         initializeMap();
        //     }
            
        // let empty = [];
        mymap.setView([38.2462420, 21.7350847], 16);
        initializeMap();
            // if (results.)
            //     results = empty;
        
        
        
        </script>
</body>
</html>